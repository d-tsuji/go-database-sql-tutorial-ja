
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Handling Errors &#8212; Go database/sql tutorial  ドキュメント</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="Working with NULLs" href="nulls.html" />
    <link rel="prev" title="Using Prepared Statements" href="prepared.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="handling-errors">
<h1>Handling Errors<a class="headerlink" href="#handling-errors" title="このヘッドラインへのパーマリンク">¶</a></h1>
<hr class="docutils" />
<p>Almost all operations with <code class="docutils literal notranslate"><span class="pre">database/sql</span></code> types return an error as the
last value. You should always check these errors, never ignore them.</p>
<p>There are a few places where error behavior is special-case, or there's
something additional you might need to know.</p>
<div class="section" id="errors-from-iterating-resultsets">
<h2>Errors From Iterating Resultsets<a class="headerlink" href="#errors-from-iterating-resultsets" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Consider the following code:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nx">pre</span> <span class="nx">class</span><span class="p">=</span><span class="s">&quot;prettyprint lang-go&quot;</span><span class="p">&gt;</span>
<span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// handle the error here</span>
<span class="p">}</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>The error from <code class="docutils literal notranslate"><span class="pre">rows.Err()</span></code> could be the result of a variety of errors
in the <code class="docutils literal notranslate"><span class="pre">rows.Next()</span></code> loop. The loop might exit for some reason other
than finishing the loop normally, so you always need to check whether
the loop terminated normally or not. An abnormal termination
automatically calls <code class="docutils literal notranslate"><span class="pre">rows.Close()</span></code>, although it's harmless to call it
multiple times.</p>
</div>
<div class="section" id="errors-from-closing-resultsets">
<h2>Errors From Closing Resultsets<a class="headerlink" href="#errors-from-closing-resultsets" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>You should always explicitly close a <code class="docutils literal notranslate"><span class="pre">sql.Rows</span></code> if you exit the loop
prematurely, as previously mentioned. It's auto-closed if the loop exits
normally or through an error, but you might mistakenly do this:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nx">pre</span> <span class="nx">class</span><span class="p">=</span><span class="s">&quot;prettyprint lang-go&quot;</span><span class="p">&gt;</span>
<span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">break</span><span class="p">;</span> <span class="c1">// whoops, rows is not closed! memory leak...</span>
<span class="p">}</span>
<span class="c1">// do the usual &quot;if err = rows.Err()&quot; [omitted here]...</span>
<span class="c1">// it&#39;s always safe to [re?]close here:</span>
<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// but what should we do if there&#39;s an error?</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>The error returned by <code class="docutils literal notranslate"><span class="pre">rows.Close()</span></code> is the only exception to the
general rule that it's best to capture and check for errors in all
database operations. If <code class="docutils literal notranslate"><span class="pre">rows.Close()</span></code> returns an error, it's unclear
what you should do. Logging the error message or panicing might be the
only sensible thing, and if that's not sensible, then perhaps you should
just ignore the error.</p>
</div>
<div class="section" id="errors-from-queryrow">
<h2>Errors From QueryRow()<a class="headerlink" href="#errors-from-queryrow" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Consider the following code to fetch a single row:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nx">pre</span> <span class="nx">class</span><span class="p">=</span><span class="s">&quot;prettyprint lang-go&quot;</span><span class="p">&gt;</span>
<span class="kd">var</span> <span class="nx">name</span> <span class="kt">string</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">QueryRow</span><span class="p">(</span><span class="s">&quot;select name from users where id = ?&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">Scan</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>What if there was no user with <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">=</span> <span class="pre">1</span></code>? Then there would be no row in
the result, and <code class="docutils literal notranslate"><span class="pre">.Scan()</span></code> would not scan a value into <code class="docutils literal notranslate"><span class="pre">name</span></code>. What
happens then?</p>
<p>Go defines a special error constant, called <code class="docutils literal notranslate"><span class="pre">sql.ErrNoRows</span></code>, which is
returned from <code class="docutils literal notranslate"><span class="pre">QueryRow()</span></code> when the result is empty. This needs to be
handled as a special case in most circumstances. An empty result is
often not considered an error by application code, and if you don't
check whether an error is this special constant, you'll cause
application-code errors you didn't expect.</p>
<p>Errors from the query are deferred until <code class="docutils literal notranslate"><span class="pre">Scan()</span></code> is called, and then
are returned from that. The above code is better written like this
instead:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nx">pre</span> <span class="nx">class</span><span class="p">=</span><span class="s">&quot;prettyprint lang-go&quot;</span><span class="p">&gt;</span>
<span class="kd">var</span> <span class="nx">name</span> <span class="kt">string</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">QueryRow</span><span class="p">(</span><span class="s">&quot;select name from users where id = ?&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">Scan</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">ErrNoRows</span> <span class="p">{</span>
        <span class="c1">// there were no rows, but otherwise no error occurred</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>One might ask why an empty result set is considered an error. There's
nothing erroneous about an empty set. The reason is that the
<code class="docutils literal notranslate"><span class="pre">QueryRow()</span></code> method needs to use this special-case in order to let the
caller distinguish whether <code class="docutils literal notranslate"><span class="pre">QueryRow()</span></code> in fact found a row; without
it, <code class="docutils literal notranslate"><span class="pre">Scan()</span></code> wouldn't do anything and you might not realize that your
variable didn't get any value from the database after all.</p>
<p>You should only run into this error when you're using <code class="docutils literal notranslate"><span class="pre">QueryRow()</span></code>. If
you encounter this error elsewhere, you're doing something wrong.</p>
</div>
<div class="section" id="identifying-specific-database-errors">
<h2>Identifying Specific Database Errors<a class="headerlink" href="#identifying-specific-database-errors" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>It can be tempting to write code like the following:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nx">pre</span> <span class="nx">class</span><span class="p">=</span><span class="s">&quot;prettyprint lang-go&quot;</span><span class="p">&gt;</span>
<span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s">&quot;SELECT someval FROM sometable&quot;</span><span class="p">)</span>
<span class="c1">// err contains:</span>
<span class="c1">// ERROR 1045 (28000): Access denied for user &#39;foo&#39;@&#39;::1&#39; (using password: NO)</span>
<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="s">&quot;Access denied&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Handle the permission-denied error</span>
<span class="p">}</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>This is not the best way to do it, though. For example, the string value
might vary depending on what language the server uses to send error
messages. It's much better to compare error numbers to identify what a
specific error is.</p>
<p>The mechanism to do this varies between drivers, however, because this
isn't part of <code class="docutils literal notranslate"><span class="pre">database/sql</span></code> itself. In the MySQL driver that this
tutorial focuses on, you could write the following code:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nx">pre</span> <span class="nx">class</span><span class="p">=</span><span class="s">&quot;prettyprint lang-go&quot;</span><span class="p">&gt;</span>
<span class="k">if</span> <span class="nx">driverErr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">mysql</span><span class="p">.</span><span class="nx">MySQLError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span> <span class="c1">// Now the error number is accessible directly</span>
    <span class="k">if</span> <span class="nx">driverErr</span><span class="p">.</span><span class="nx">Number</span> <span class="o">==</span> <span class="mi">1045</span> <span class="p">{</span>
        <span class="c1">// Handle the permission-denied error</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Again, the <code class="docutils literal notranslate"><span class="pre">MySQLError</span></code> type here is provided by this specific driver,
and the <code class="docutils literal notranslate"><span class="pre">.Number</span></code> field may differ between drivers. The value of the
number, however, is taken from MySQL's error message, and is therefore
database specific, not driver specific.</p>
<p>This code is still ugly. Comparing to 1045, a magic number, is a code
smell. Some drivers (though not the MySQL one, for reasons that are
off-topic here) provide a list of error identifiers. The Postgres <code class="docutils literal notranslate"><span class="pre">pq</span></code>
driver does, for example, in
<a class="reference external" href="https://github.com/lib/pq/blob/master/error.go">error.go</a>. And
there's an external package of <a class="reference external" href="https://github.com/VividCortex/mysqlerr">MySQL error numbers maintained by
VividCortex</a>. Using such a
list, the above code is better written thus:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nx">pre</span> <span class="nx">class</span><span class="p">=</span><span class="s">&quot;prettyprint lang-go&quot;</span><span class="p">&gt;</span>
<span class="k">if</span> <span class="nx">driverErr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">mysql</span><span class="p">.</span><span class="nx">MySQLError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">driverErr</span><span class="p">.</span><span class="nx">Number</span> <span class="o">==</span> <span class="nx">mysqlerr</span><span class="p">.</span><span class="nx">ER_ACCESS_DENIED_ERROR</span> <span class="p">{</span>
        <span class="c1">// Handle the permission-denied error</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="handling-connection-errors">
<h2>Handling Connection Errors<a class="headerlink" href="#handling-connection-errors" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>What if your connection to the database is dropped, killed, or has an
error?</p>
<p>You don't need to implement any logic to retry failed statements when
this happens. As part of the <a class="reference external" href="connection-pool.html">connection
pooling</a> in <code class="docutils literal notranslate"><span class="pre">database/sql</span></code>, handling failed
connections is built-in. If you execute a query or other statement and
the underlying connection has a failure, Go will reopen a new connection
(or just get another from the connection pool) and retry, up to 10
times.</p>
<p>There can be some unintended consequences, however. Some types of errors
may be retried when other error conditions happen. This might also be
driver-specific. One example that has occurred with the MySQL driver is
that using <code class="docutils literal notranslate"><span class="pre">KILL</span></code> to cancel an undesired statement (such as a
long-running query) results in the statement being retried up to 10
times.</p>
<p><strong>Previous: `Using Prepared Statements &lt;prepared.html&gt;`__</strong> <strong>Next:
`Working with NULLs &lt;nulls.html&gt;`__</strong></p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div id="toc" class="sidebarRow">
    <h5>GO DATABASE/SQL TUTORIAL</h5>
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="importing.html">Importing a Database Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessing.html">Accessing the Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="retrieving.html">Retrieving Result Sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="modifying.html">Modifying Data and Using Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="prepared.html">Using Prepared Statements</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Handling Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="nulls.html">Working with NULLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="varcols.html">Working with Unknown Columns</a></li>
<li class="toctree-l1"><a class="reference internal" href="connection-pool.html">The Connection Pool</a></li>
<li class="toctree-l1"><a class="reference internal" href="surprises.html">Surprises, Antipatterns and Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">Related Reading and Resources</a></li>
</ul>

    
</div>

<style type="text/css">
    .toctree-l1 {
        font-size: 12px;
        margin-bottom: 0;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.33;
        padding-bottom: 5px;
        margin: 2px;
    }
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;VividCortex (translated by @d-tsuji).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/errors.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>